#!/bin/sh

# Load config file
CONFIG_FILE="/etc/fancontrol.conf"
if [ -f "$CONFIG_FILE" ]; then
    . "$CONFIG_FILE"
else
    echo "Config file not found: $CONFIG_FILE"
    exit 1
fi

# If ENABLE_CONTROLS is set, toggle pwm1_enable
if [ "$ENABLE_CONTROLS" = "1" ]; then
    echo 1 > "$HWMON/pwm1_enable"
else
    echo 2 > "$HWMON/pwm1_enable"   # 2 = automatic mode
fi

# Restore auto mode on exit
trap 'echo 2 > "$HWMON/pwm1_enable"; exit 0' INT TERM

while true; do
    # Read temperature (temp1_input is in millidegrees C)
    rawtemp=$(cat $TEMP_SENSOR)
    currentTemp=$((rawtemp / 1000))

    # Default to min
    newPWM=$MIN_PWM

    if [ $currentTemp -ge $MAX_TEMP ]; then
        newPWM=$MAX_PWM
    elif [ $currentTemp -gt $MIN_TEMP ]; then
        # Linear interpolation
        newPWM=$(( ( (currentTemp - MIN_TEMP) * (MAX_PWM - MIN_PWM) / (MAX_TEMP - MIN_TEMP) ) + MIN_PWM ))
    fi

    # Cap PWM
    [ "$newPWM" -lt 0 ] && newPWM=0
    [ "$newPWM" -gt 255 ] && newPWM=255

    # Apply fan speed
    [ "$ENABLE_CONTROLS" = "1" ] && printf "%s" "$newPWM" > "$PWM"

    # Log to systemd journal
    logger -t fancontrol "Temp: ${currentTemp}Â°C -> Fan PWM: $newPWM"

    sleep $INTERVAL
done
