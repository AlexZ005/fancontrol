#!/bin/sh

# Load config
. /etc/fancontrol.conf
HWMON=/sys/class/hwmon/hwmon0
TEMP_SENSOR=$HWMON/temp1_input
PWM=$HWMON/pwm1

# Enable manual mode
echo 1 > $HWMON/pwm1_enable

while true; do
    # Read temperature (temp1_input is in millidegrees C)
    rawtemp=$(cat $TEMP_SENSOR)
    currentTemp=$((rawtemp / 1000))

    # Default to min
    newPWM=$MIN_PWM

    if [ $currentTemp -ge $MAX_TEMP ]; then
        newPWM=$MAX_PWM
    elif [ $currentTemp -gt $MIN_TEMP ]; then
        # Linear interpolation
        newPWM=$(( ( (currentTemp - MIN_TEMP) * (MAX_PWM - MIN_PWM) / (MAX_TEMP - MIN_TEMP) ) + MIN_PWM ))
    fi

    # Apply fan speed
    echo $newPWM > $PWM

    # Log to systemd journal
    logger -t fancontrol "Temp: ${currentTemp}Â°C -> Fan PWM: $newPWM"

    sleep $INTERVAL
done
